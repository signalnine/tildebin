"""Tests for cpu_vulnerability script."""

import pytest

from boxctl.core.output import Output


class TestCpuVulnerability:
    """Tests for cpu_vulnerability script."""

    def test_missing_vuln_dir_returns_error(self, mock_context):
        """Returns exit code 2 when vulnerability interface not available."""
        from scripts.baremetal import cpu_vulnerability

        ctx = mock_context(
            file_contents={},  # No vulnerability directory
        )
        output = Output()

        exit_code = cpu_vulnerability.run([], output, ctx)

        assert exit_code == 2
        assert len(output.errors) > 0
        assert any("vulnerability" in e.lower() for e in output.errors)

    def test_all_mitigated(self, mock_context):
        """Returns 0 when all vulnerabilities are mitigated."""
        from scripts.baremetal import cpu_vulnerability

        ctx = mock_context(
            file_contents={
                '/sys/devices/system/cpu/vulnerabilities': '',  # dir marker
                '/sys/devices/system/cpu/vulnerabilities/spectre_v1': 'Mitigation: usercopy/swapgs barriers',
                '/sys/devices/system/cpu/vulnerabilities/spectre_v2': 'Mitigation: IBRS, IBPB',
                '/sys/devices/system/cpu/vulnerabilities/meltdown': 'Not affected',
                '/proc/cpuinfo': 'vendor_id\t: GenuineIntel\nmodel name\t: Intel Xeon\n',
                '/proc/cmdline': 'root=/dev/sda1 quiet',
            }
        )
        output = Output()

        exit_code = cpu_vulnerability.run([], output, ctx)

        assert exit_code == 0
        assert 'vulnerabilities' in output.data
        assert all(v['mitigated'] for v in output.data['vulnerabilities'])

    def test_vulnerable_detected(self, mock_context):
        """Returns 1 when vulnerabilities are not mitigated."""
        from scripts.baremetal import cpu_vulnerability

        ctx = mock_context(
            file_contents={
                '/sys/devices/system/cpu/vulnerabilities': '',
                '/sys/devices/system/cpu/vulnerabilities/spectre_v1': 'Vulnerable',
                '/sys/devices/system/cpu/vulnerabilities/spectre_v2': 'Mitigation: IBRS',
                '/proc/cpuinfo': 'vendor_id\t: GenuineIntel\n',
                '/proc/cmdline': 'root=/dev/sda1',
            }
        )
        output = Output()

        exit_code = cpu_vulnerability.run([], output, ctx)

        assert exit_code == 1
        vulns = output.data['vulnerabilities']
        spectre_v1 = next(v for v in vulns if v['name'] == 'spectre_v1')
        assert spectre_v1['severity'] == 'CRITICAL'
        assert not spectre_v1['mitigated']

    def test_cmdline_mitigations_off(self, mock_context):
        """Returns 1 when mitigations=off in kernel cmdline."""
        from scripts.baremetal import cpu_vulnerability

        ctx = mock_context(
            file_contents={
                '/sys/devices/system/cpu/vulnerabilities': '',
                '/sys/devices/system/cpu/vulnerabilities/spectre_v1': 'Vulnerable: __user pointer sanitization disabled',
                '/proc/cpuinfo': 'vendor_id\t: GenuineIntel\n',
                '/proc/cmdline': 'root=/dev/sda1 mitigations=off',
            }
        )
        output = Output()

        exit_code = cpu_vulnerability.run([], output, ctx)

        assert exit_code == 1
        assert len(output.data['cmdline_issues']) > 0
        assert any('mitigations=off' in issue['pattern'] for issue in output.data['cmdline_issues'])

    def test_cmdline_specific_disable(self, mock_context):
        """Detects specific mitigation disables in cmdline."""
        from scripts.baremetal import cpu_vulnerability

        ctx = mock_context(
            file_contents={
                '/sys/devices/system/cpu/vulnerabilities': '',
                '/sys/devices/system/cpu/vulnerabilities/meltdown': 'Vulnerable',
                '/proc/cpuinfo': '',
                '/proc/cmdline': 'root=/dev/sda1 nopti nospectre_v2',
            }
        )
        output = Output()

        exit_code = cpu_vulnerability.run([], output, ctx)

        assert exit_code == 1
        cmdline_issues = output.data['cmdline_issues']
        patterns = [issue['pattern'] for issue in cmdline_issues]
        assert 'nopti' in patterns
        assert 'nospectre_v2' in patterns

    def test_verbose_includes_cpu_details(self, mock_context):
        """--verbose includes additional CPU details."""
        from scripts.baremetal import cpu_vulnerability

        ctx = mock_context(
            file_contents={
                '/sys/devices/system/cpu/vulnerabilities': '',
                '/sys/devices/system/cpu/vulnerabilities/meltdown': 'Not affected',
                '/proc/cpuinfo': (
                    'vendor_id\t: GenuineIntel\n'
                    'model name\t: Intel Xeon\n'
                    'cpu family\t: 6\n'
                    'model\t: 85\n'
                    'stepping\t: 7\n'
                    'microcode\t: 0x5003604\n'
                ),
                '/proc/cmdline': '',
            }
        )
        output = Output()

        exit_code = cpu_vulnerability.run(['--verbose'], output, ctx)

        assert exit_code == 0
        assert output.data['cpu']['cpu_family'] == '6'
        assert output.data['cpu']['model'] == '85'
        assert output.data['cpu']['stepping'] == '7'

    def test_not_affected_is_mitigated(self, mock_context):
        """'Not affected' status counts as mitigated."""
        from scripts.baremetal import cpu_vulnerability

        ctx = mock_context(
            file_contents={
                '/sys/devices/system/cpu/vulnerabilities': '',
                '/sys/devices/system/cpu/vulnerabilities/l1tf': 'Not affected',
                '/proc/cpuinfo': '',
                '/proc/cmdline': '',
            }
        )
        output = Output()

        exit_code = cpu_vulnerability.run([], output, ctx)

        assert exit_code == 0
        l1tf = output.data['vulnerabilities'][0]
        assert l1tf['mitigated'] is True
        assert l1tf['severity'] == 'OK'

    def test_kvm_mitigation_recognized(self, mock_context):
        """KVM-specific mitigation is recognized."""
        from scripts.baremetal import cpu_vulnerability

        ctx = mock_context(
            file_contents={
                '/sys/devices/system/cpu/vulnerabilities': '',
                '/sys/devices/system/cpu/vulnerabilities/itlb_multihit': 'KVM: Mitigation: VMX disabled',
                '/proc/cpuinfo': '',
                '/proc/cmdline': '',
            }
        )
        output = Output()

        exit_code = cpu_vulnerability.run([], output, ctx)

        assert exit_code == 0
        vuln = output.data['vulnerabilities'][0]
        assert vuln['mitigated'] is True
